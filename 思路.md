# 自动化交易系统设计思路

## 系统架构概述
本系统是一个基于信号驱动的自动化期货交易系统，通过Socket.IO接收交易信号，自动执行买入、卖出和平仓操作。

## 核心模块设计

### 1. HTTP API 服务模块 (配置管理)
**功能**: 接收和管理系统配置信息
- **接口**: POST /api
- **数据格式**: 
  ```json
  {
    "action": "事件类型",
    "data": {...}  // 根据事件类型包含不同的内容
  }
  ```
- **支持的事件类型**:
  - `header`: 更新请求头配置
    - 记录最后一次收到的时间戳
    - 新鲜度判断：如果数据超过1分钟没有更新，判断为掉线
    - 自动调用Bark API通知手机进行重连
  - `config`: 更新交易配置(包含合约、数量等)
  - `status`: 查询系统状态

**连接状态监控**:
- **心跳检测**: 定时检查header更新时间
- **掉线通知**: 通过Bark推送服务发送手机通知
- **状态恢复**: 检测到新的header请求时自动恢复正常状态

### 2. 交易执行模块 (Axios HTTP Client)
**功能**: 封装交易所API调用
- **基础配置**: 使用步骤1中获取的headers和baseURL
- **支持操作**:
  - `openLong(amount)`: 开多仓
  - `openShort(amount)`: 开空仓  
  - `closePosition()`: 平仓
  - `getAccount()`: 查询账户信息
  - `getPositions()`: 查询持仓信息

**API映射** (基于Gate.io):

#### 开仓操作
- **接口**: POST /apiw/v2/futures/usdt/orders
- **请求数据**:
  ```json
  {
    "contract": "BTC_USDT",
    "price": "",                // 空字符串表示市价单
    "size": "1",               // 正数=多仓，负数=空仓，单位：张
    "reduce_only": false,      // false=开仓，true=平仓
    "tif": "gtc",             // 订单有效期：gtc=撤销前有效
    "bbo": "opp",             // 最优价格类型
    "text": "auto_trade"      // 订单标识
  }
  ```

#### 平仓操作
- **接口**: POST /apiw/v2/futures/usdt/positions/close_all
- **请求数据**:
  ```json
  {
    "only_close_positions": false  // false=平仓并取消挂单
  }
  ```

#### 查询接口
- **账户信息**: GET /apiw/v2/futures/usdt/accounts
- **持仓信息**: GET /apiw/v2/futures/usdt/positions
- **返回数据**: 详见 raw_data 文件中的示例
### 3. 信号接收模块 (Socket.IO Client)
**功能**: 连接交易信号服务器，接收实时交易指令
- **连接目标**: 指定的Socket.IO服务端
- **监听事件**: `action`
- **信号格式**: 简化设计，只关注direction，其他参数从配置中读取
  ```json
  {
    "direction": "buy|sell|close",
    "timestamp": 1234567890      // 可选：信号时间戳
  }
  ```


**信号处理逻辑**:
- `buy`: 调用 openLong(配置的amount)
- `sell`: 调用 openShort(配置的amount)  
- `close`: 调用 closePosition()

**连接管理**:
- 自动重连机制
- 连接状态监控
- 心跳检测

## 系统优化建议

### 4. 日志监控模块 (新增)
**功能**: 记录和监控系统运行状态
- **交易日志**: 记录所有交易操作和结果（时间、方向、数量、价格、结果）
- **错误日志**: 记录系统异常和错误（API错误、网络异常等）
- **性能监控**: 监控API响应时间和成功率
- **资金变化**: 定时(每10s)跟踪账户余额变化
- **日志格式**: 统一的JSON格式，便于后续分析

### 5. 配置管理优化
**功能**: 简化的配置管理
- **连接配置**: Socket.IO服务器地址、重连参数
- **系统参数**: 日志级别、API超时时间等
- **运行时更新**: 支持通过API接口动态更新配置

### 6. 通知服务模块 (新增)
**功能**: 系统状态异常通知
- **掉线检测**: 监控header更新时间，超过1分钟未更新视为掉线
- **Bark推送**: 发送iOS推送通知到手机
- **通知内容**: 包含掉线时间、系统状态等信息
- **恢复通知**: 连接恢复时发送恢复通知

**Bark API调用示例**:
```javascript
// 发送掉线通知
POST https://api.day.app/YOUR_KEY/交易系统掉线/请检查网络连接状态
```



## 技术栈建议
- **后端框架**: Express.js + Socket.IO Client
- **HTTP客户端**: Axios
- **日志系统**: Winston (文件日志)
- **配置管理**: 本地JSON文件 + 内存缓存
- **推送通知**: Bark API (iOS推送服务)
- **进程管理**: PM2 (可选，用于生产环境)

## 项目结构
```
trading-system/
├── src/
│   ├── config/
│   │   ├── default.json      # 系统默认配置
│   │   └── runtime.json      # 运行时配置(API接收的配置)
│   ├── modules/
│   │   ├── httpClient.js     # HTTP客户端封装
│   │   ├── socketClient.js   # Socket.IO客户端
│   │   ├── tradeExecutor.js  # 交易执行器
│   │   ├── notificationService.js  # Bark通知服务
│   │   └── logger.js         # 日志管理
│   ├── api/
│   │   └── configApi.js      # 配置API服务
│   └── app.js                # 主程序入口
├── logs/                     # 日志目录
├── package.json
└── README.md
```

## 部署架构
```
[信号源] -> [Socket.IO Client] -> [交易系统] -> [Gate.io API]
                                      ↓
                                 [日志监控]
                                      ↓
                                 [配置管理] <- [HTTP API]
```

## 实现优先级
1. **第一阶段**: 核心功能实现
   - HTTP API配置服务
   - 交易执行模块
   - Socket.IO信号接收
   - 基础日志记录

2. **第二阶段**: 监控和通知
   - 心跳检测机制
   - Bark通知服务
   - 完善日志监控
   - 错误处理优化

3. **第三阶段**: 扩展功能
   - 配置热更新
   - 性能优化
   - 监控面板(可选)

## 关键配置参数

### 系统默认配置 (default.json)
```json
{
  "socket": {
    "url": "ws://localhost:3001",   // Socket.IO服务器地址
    "reconnectDelay": 5000,         // 重连延迟(ms)
    "maxReconnectAttempts": 10      // 最大重连次数
  },
  "system": {
    "logLevel": "info",             // 日志级别
    "apiTimeout": 10000,            // API请求超时(ms)
    "accountQueryInterval": 10000,  // 账户查询间隔(ms)
    "heartbeatInterval": 60000      // 心跳检测间隔(ms)
  },
  "notification": {
    "barkUrl": "https://api.day.app/YOUR_KEY",  // Bark推送URL
    "enabled": true,                            // 是否启用通知
    "title": "交易系统告警"                      // 通知标题
  }
}
```

### 运行时配置 (通过API接收)
```json
{
  "api": {
    "baseURL": "https://www.gate.com",
    "headers": {
      "Cookie": "token=...; csrftoken=..."
    }
  },
  "trading": {
    "contract": "BTC_USDT",
    "amount": 1                     // 每次交易张数
  }
}
```

## 运行流程
1. **启动阶段**:
   - 加载配置文件
   - 初始化日志系统
   - 启动HTTP API服务
   - 连接Socket.IO服务器

2. **运行阶段**:
   - 监听Socket.IO信号
   - 根据信号调用交易API
   - 记录交易日志
   - 定时查询账户状态

3. **异常处理**:
   - API调用失败重试
   - Socket连接断开重连
   - 记录错误日志

